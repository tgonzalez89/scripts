from openpyxl import Workbook
from openpyxl.formatting.rule import ColorScaleRule
from openpyxl.utils import get_column_letter


def create_excel_file(data):
    # Enumerate the data to capture original indices (season numbers)
    indexed_data = list(enumerate(data))  # Each item is now (original_index, (avg_rating, episode_ratings))

    # Sort data by average rating in descending order
    sorted_data = sorted(indexed_data, key=lambda x: x[1][0], reverse=True)  # Sort by avg_rating (x[1][0])

    # Create a new Excel workbook
    wb = Workbook()
    ws = wb.active

    # Set column headers
    ws["A1"] = "Season"
    ws["B1"] = "Average"
    ws["D1"] = "Episode Ratings"
    # Set episode number headers
    episodes_max = max(len(tup[1]) for tup in data)
    for i in range(episodes_max):
        ws.cell(row=2, column=4 + i, value=i + 1)

    # Create color scale rule
    color_scale_rule = ColorScaleRule(
        start_type="min",
        start_value=0,
        start_color="ff4000",
        mid_type="percentile",
        mid_value=50,
        mid_color="ffffff",
        end_type="max",
        end_value=10,
        end_color="2a6099",
    )

    # Iterate through sorted data and write to Excel
    for sorted_data_idx, (data_idx, (avg_rating, episode_ratings)) in enumerate(sorted_data):
        row = 3 + sorted_data_idx
        # Write season number
        ws.cell(
            row=row,
            column=1,
            value=data_idx + 1,  # Season number
        )
        # Write average rating
        ws.cell(row=row, column=2, value=avg_rating).number_format = "0.0"
        # Write episode ratings
        for i, rating in enumerate(episode_ratings):
            ws.cell(row=row, column=4 + i, value=rating).number_format = "0.0"

    # Apply color scale rule
    ws.conditional_formatting.add(
        f"B3:{get_column_letter(4 + episodes_max)}{3 + len(sorted_data) - 1}", color_scale_rule
    )

    # Save the workbook to a file
    wb.save("survivor-ratings.xlsx")


scraped_data = [
    (7.5214285714285710, [7.9, 7.4, 7.4, 7.3, 7.3, 7.4, 7.9, 7.5, 7.5, 7.4, 7.6, 7.6, 8.6, 6.5]),
    (7.4235294117647060, [7.7, 7.5, 7.4, 7.5, 7.5, 8.4, 7.8, 7.4, 6.2, 7.8, 7.6, 7.7, 7.5, 7.3, 7.7, 6.5, 6.7]),
    (7.2647058823529410, [7.1, 7.5, 7.4, 7.5, 7.5, 7.8, 7.7, 7.6, 6.0, 7.7, 7.6, 7.4, 7.4, 7.3, 7.8, 6.5, 5.7]),
    (7.3733333333333330, [7.4, 7.4, 7.7, 7.4, 7.5, 7.6, 8.0, 8.0, 6.7, 7.4, 7.3, 7.4, 7.7, 7.6, 5.5]),
    (7.1600000000000000, [7.4, 7.3, 7.5, 7.3, 7.4, 7.4, 7.4, 7.3, 7.0, 7.0, 7.0, 6.8, 7.3, 7.3, 6.0]),
    (7.7666666666666670, [8.0, 7.7, 7.8, 7.7, 7.9, 7.8, 8.4, 7.7, 7.9, 6.9, 8.1, 8.0, 8.1, 7.8, 6.7]),
    (8.2733333333333330, [8.8, 8.0, 7.9, 8.3, 7.9, 8.4, 8.7, 8.4, 7.8, 8.5, 8.6, 7.9, 8.4, 8.6, 7.9]),
    (7.7555555555555555, [8.3, 7.8, 8.2, 7.8, 8.0, 7.2, 7.7, 7.6, 7.4, 7.9, 8.3, 7.6, 7.9, 7.5, 7.7, 8.0, 7.7, 7.0]),
    (7.6600000000000000, [7.8, 7.7, 7.8, 7.5, 7.6, 7.6, 7.4, 7.7, 7.6, 7.4, 8.3, 7.7, 7.8, 8.1, 6.9]),
    (8.0066666666666660, [8.1, 7.8, 7.9, 8.0, 8.1, 7.9, 8.0, 8.2, 8.1, 8.0, 7.8, 8.1, 8.0, 8.5, 7.6]),
    (7.7266666666666675, [7.9, 7.7, 7.5, 7.7, 7.8, 7.6, 7.4, 7.8, 7.9, 7.9, 7.7, 8.0, 7.7, 8.0, 7.3]),
    (7.5312500000000000, [7.7, 7.5, 7.5, 7.4, 7.7, 7.4, 6.6, 7.5, 7.5, 7.6, 7.8, 8.0, 7.9, 7.6, 7.7, 7.1]),
    (7.7562500000000000, [8.0, 7.7, 7.6, 7.8, 7.6, 7.9, 6.3, 7.8, 8.1, 8.2, 8.4, 7.9, 7.6, 7.7, 8.0, 7.5]),
    (7.2399999999999990, [6.9, 6.9, 6.8, 7.1, 7.0, 7.2, 7.5, 7.3, 7.2, 8.1, 7.3, 7.1, 8.0, 7.5, 6.7]),
    (7.6200000000000000, [7.6, 7.5, 7.5, 7.3, 7.6, 8.0, 8.0, 8.0, 7.7, 6.5, 8.1, 7.5, 7.8, 7.9, 7.3]),
    (7.8866666666666670, [7.8, 7.6, 7.6, 7.6, 7.8, 7.6, 7.6, 7.5, 8.0, 8.7, 8.0, 8.6, 8.7, 8.0, 7.2]),
    (7.4714285714285710, [7.5, 7.2, 7.3, 7.0, 7.2, 7.6, 7.6, 7.5, 8.4, 6.4, 7.6, 8.1, 8.1, 7.1]),
    (7.4666666666666670, [7.5, 7.4, 7.3, 7.2, 7.4, 6.4, 7.3, 7.5, 8.0, 8.1, 7.4, 7.4, 8.1, 7.9, 7.1]),
    (7.4500000000000000, [7.6, 7.4, 7.5, 7.2, 7.3, 7.8, 7.2, 8.0, 8.5, 8.4, 5.7, 7.4, 7.5, 7.3, 7.8, 6.6]),
    (8.2750000000000000, [8.0, 8.7, 8.1, 8.0, 8.3, 8.0, 9.0, 8.4, 8.0, 8.3, 8.9, 8.0, 8.4, 8.2, 8.4, 7.7]),
    (7.0125000000000000, [7.1, 7.4, 6.7, 6.9, 6.8, 7.0, 6.9, 7.2, 7.1, 7.2, 6.3, 7.1, 6.9, 7.2, 7.7, 6.7]),
    (6.9066666666666660, [7.7, 7.1, 7.3, 7.0, 6.7, 6.4, 6.8, 7.3, 6.7, 6.8, 6.6, 6.6, 6.8, 7.1, 6.7]),
    (7.4250000000000000, [7.8, 7.3, 7.3, 7.1, 7.8, 7.5, 8.1, 8.2, 7.5, 7.2, 6.4, 7.3, 7.2, 7.9, 7.3, 6.9]),
    (7.0666666666666660, [7.1, 6.7, 7.2, 6.4, 7.1, 7.6, 7.1, 7.4, 7.2, 7.1, 7.1, 7.2, 7.2, 7.2, 6.4]),
    (7.8066666666666670, [7.8, 7.6, 7.4, 7.9, 7.7, 7.4, 7.9, 8.7, 8.4, 7.8, 8.0, 7.2, 7.9, 8.2, 7.2]),
    (7.5733333333333330, [7.6, 7.3, 7.1, 7.3, 8.6, 7.0, 6.9, 8.0, 8.1, 9.0, 7.6, 7.7, 7.9, 7.6, 5.9]),
    (7.4466666666666670, [7.4, 7.2, 7.5, 8.0, 7.4, 7.0, 7.3, 7.4, 7.2, 7.7, 7.6, 8.6, 7.5, 7.4, 6.5]),
    (8.1071428571428580, [8.4, 7.7, 8.0, 8.0, 7.8, 9.1, 7.9, 8.1, 7.9, 8.4, 7.9, 8.5, 8.7, 7.1]),
    (7.5642857142857150, [7.4, 7.6, 7.7, 7.9, 7.2, 7.1, 6.7, 7.5, 7.9, 8.3, 7.6, 7.9, 8.3, 6.8]),
    (7.7428571428571420, [7.8, 7.4, 7.0, 7.5, 7.6, 8.2, 7.6, 7.5, 8.1, 8.1, 7.7, 8.4, 8.2, 7.3]),
    (8.3928571428571420, [8.5, 8.4, 8.2, 8.0, 8.3, 8.6, 8.1, 9.2, 8.3, 9.3, 8.3, 7.9, 9.0, 7.4]),
    (7.6666666666666670, [7.5, 7.9, 7.7, 8.2, 7.4, 7.6, 7.2, 8.0, 8.6, 8.9, 7.6, 7.5, 7.2, 7.7, 6.0]),
    (7.8642857142857140, [7.6, 7.6, 7.5, 8.2, 7.4, 7.7, 8.2, 7.7, 7.7, 8.9, 8.2, 7.7, 8.4, 7.3]),
    (7.9230769230769230, [8.4, 7.5, 8.9, 8.3, 8.0, 8.3, 7.8, 8.1, 7.5, 7.3, 8.0, 7.9, 7.0]),
    (7.2642857142857140, [7.2, 6.8, 7.0, 7.7, 7.1, 6.9, 7.4, 7.5, 7.3, 8.2, 8.2, 7.8, 7.4, 5.2]),
    (7.1928571428571430, [7.6, 7.4, 7.9, 6.9, 6.9, 7.4, 8.0, 7.4, 7.4, 7.3, 6.8, 6.9, 7.6, 5.2]),
    (8.0928571428571430, [8.2, 7.7, 7.8, 8.2, 8.2, 7.6, 8.0, 9.0, 8.8, 8.1, 8.4, 8.0, 8.1, 7.2]),
    (7.8000000000000000, [7.6, 7.5, 7.6, 7.9, 8.2, 7.9, 8.3, 8.6, 7.6, 7.7, 8.4, 7.7, 7.4, 6.8]),
    (7.2500000000000000, [7.5, 7.7, 7.3, 7.8, 7.2, 8.1, 8.0, 5.0, 7.4, 7.7, 6.8, 7.2, 7.3, 6.5]),
    (8.3466666666666680, [8.1, 8.9, 8.2, 8.1, 8.0, 8.0, 8.8, 7.6, 8.1, 8.7, 8.2, 8.9, 8.4, 8.2, 9.0]),
    (5.9461538461538460, [4.9, 5.7, 5.7, 6.3, 5.9, 5.4, 6.9, 6.2, 6.6, 7.4, 5.4, 5.9, 5.0]),
    (7.4083333333333320, [7.4, 7.3, 8.0, 7.2, 7.2, 7.6, 7.3, 5.1, 7.3, 8.7, 8.2, 7.6]),
    (7.4384615384615390, [7.2, 7.6, 7.2, 7.2, 7.3, 7.4, 6.8, 7.0, 7.8, 7.5, 7.7, 8.9, 7.1]),
    (7.4846153846153850, [7.7, 7.5, 7.2, 7.6, 7.3, 7.2, 6.7, 7.9, 7.4, 7.5, 8.3, 7.6, 7.4]),
    (7.5153846153846150, [6.2, 7.1, 8.1, 6.2, 7.1, 8.9, 7.1, 8.5, 7.4, 7.8, 7.7, 7.9, 7.7]),
    (7.3500000000000000, [7.1, 6.8, 6.0, 5.5, 7.3, 7.2, 8.0, 8.5, 8.1, 9.0]),
]

create_excel_file(scraped_data)
